# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリのコードを扱う際のガイダンスを提供します。

## 言語

コメントやドキュメントでは必ず日本語を使ってください。

## 品質保証ルール

### 作業完了時の必須手順

作業を終了する際は、必ず以下の手順を実行してコードの品質を保証してください：

#### 1. フォーマッター実行（必須）

```bash
npm run format
```

- Prettierによるコードフォーマットの統一
- コードスタイルの一貫性を保証

#### 2. Linter実行

```bash
npm run lint
```

- ESLintによるコード品質チェック
- エラーがある場合は修正する

#### 3. 型チェック

```bash
npx tsc --noEmit
```

- TypeScriptの型エラーチェック
- 型エラーがある場合は修正する

#### 4. テスト実行

```bash
npm test
```

- 全テストケースの実行
- テストが失敗する場合は修正する

#### 5. ビルド確認

```bash
npm run build
```

- プロダクションビルドの成功確認
- ビルドエラーがある場合は修正する

## 開発サーバーの管理

### サーバーの停止方法

開発サーバーを停止する際は、他のプロジェクトに影響を与えないよう、必ず`npx kill-port`を使用してください：

```bash
npx kill-port <ポート番号>
```

例：
```bash
npx kill-port 3456
```

**注意**: `pkill`やプロセス名での終了は他の開発者のサーバーも停止してしまう可能性があるため使用しないでください。

### コードフォーマット

- **Prettier設定**: `.prettierrc`に基づいてフォーマット
- **フォーマット確認**: `npm run format:check`でフォーマット済みかチェック
- **自動修正**: `npm run format`で自動フォーマット適用
- **設定方針**: セミコロンあり、シングルクォート、改行文字LF、タブ幅2スペース

### テストケース作成指針

- 新しい機能を実装する際は、対応するテストケースを必ず作成する
- 以下のテストパターンを網羅する：
  - 正常系のテスト
  - 異常系のテスト（エラーハンドリング）
  - 境界値テスト
  - エッジケーステスト
- テストカバレッジは80%以上を目指す

### コード品質基準

- TypeScriptの厳密な型定義を使用する
- ESLintルールに準拠する
- 関数とクラスには適切なJSDocコメントを記載する
- エラーハンドリングを適切に実装する
- Prettierによる統一されたコードフォーマットを維持する

## Playwright MCPサーバーを使用した機能テスト
UIに関わる変更をした際には意図通りに変更できていることをPlaywright MCPを使いスクリーンショットで確認してください。  
取得したスクリーンショットは作業ディレクトリを作成してそこに保存してください。  

### 1. ブラウザの起動とページナビゲート
開発サーバーは適当なポートでオープンしてください。

```
PORT=<port> npm run dev
```

```bash
# MCPサーバーでブラウザを開く
mcp__playwright__browser_navigate url:"http://localhost:<port>"
```

### 2. ページスナップショットの取得

```bash
# 現在のページの状態を確認
mcp__playwright__browser_snapshot
```

## グラフ機能のリアルタイムデータ受信テスト手順

### 前提条件
- DBCファイルとWebSocketサンプル送信プログラムのCAN IDが一致している必要がある
- `toyota_nodsu_pt_generated.dbc`にはID 170 (0x0AA) WHEEL_SPEEDSメッセージが含まれている

### テスト手順

#### 1. 開発サーバーの起動
```bash
PORT=3456 npm run dev
```

#### 2. WebSocketサンプル送信プログラムのポート設定確認
WebSocketサンプル送信プログラム（`examples/websocket-can-sender.ts`）のポートが開発サーバーと一致していることを確認し、必要に応じて修正：
```typescript
const WS_URL = 'ws://localhost:3456/ws';
```

#### 3. アプリケーションでDBCファイルをアップロード
- ブラウザでトップページ（http://localhost:3456）にアクセス
- 「DBCファイルを選択」ボタンをクリック
- ファイル選択ダイアログから`dbc/toyota_nodsu_pt_generated.dbc`をアップロード

#### 4. CAN値表示タブでリアルタイム受信を開始
- 「CAN値表示」タブに移動
- 「リアルタイム開始」ボタンをクリック
- 接続状態が「● 接続中」と表示されることを確認

#### 5. グラフタブでシグナルを選択
- 「グラフ表示」タブに移動
- 左側のシグナル選択から表示したいシグナルを選択（例：WHEEL_SPEED_FL）

#### 6. WebSocketサンプル送信プログラムを実行
WebSocketサンプル送信プログラムを実行：
```bash
cd examples && npx tsx websocket-can-sender.ts
```

#### 7. グラフ表示の確認
- 選択したシグナルのリアルタイムデータがグラフに表示される
- データが受信されない場合は「グラフデータなし」と表示される

### トラブルシューティング
- グラフにデータが表示されない場合：
  - DBCファイルのメッセージIDとWebSocket送信プログラムのIDが一致しているか確認
  - CAN値表示タブでリアルタイム受信が有効になっているか確認
  - WebSocket接続が正常に確立されているか確認
